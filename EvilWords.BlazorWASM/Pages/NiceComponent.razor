@using System.Collections.Immutable
@using BlafettisLib
@using MudBlazor
@inject Blazored.LocalStorage.ILocalStorageService _localStorage



<MudList>
    @for (var guessResultIndex = 0; guessResultIndex < GameState.PreviousGuesses.Count; guessResultIndex++)
    {
        var guessResult = GameState.PreviousGuesses[guessResultIndex];

        <MudListItem>
            
            @for (var charResultIndex = 0; charResultIndex < guessResult.Results.Count; charResultIndex++)
            {
                var charResult = guessResult.Results[charResultIndex];

                <MudButton
                    Color="charResult.ResultColor.GetColor()"
                    Variant="Variant.Filled">
                    @charResult.Character
                </MudButton>
            }

        </MudListItem>
    }
    
    @if (IsGameOver)
    {
        <MudListItem>
            @if (GameState.IsWin)
            {
                <MudText Typo="Typo.h6">You are victorious!</MudText>
            }
            else if(History.Results.Any())
            {
                <MudText Typo="Typo.h6">Sorry, honey, the word was</MudText>
                <MudText Typo="Typo.h2">@History.Results.Last().HiddenWord</MudText>
            }
        </MudListItem>

        <MudListItem>
            <MudButton OnClick="Restart">New Game</MudButton>
        </MudListItem>

        <MudListItem>
        
            <MudChart ChartType="ChartType.Bar" 
                      ChartOptions="new ChartOptions(){DisableLegend = true, XAxisLines = false, YAxisLines = false}"
                      ChartSeries="@(new List<ChartSeries>(){
                                       new (){Data =@History.Results.Select(x=>x.Guesses??0d).ToArray() }
                                   })"  
                      XAxisLabels="@History.Results.Select(x=>x.HiddenWord).ToArray()"
                      Width="100%" 
                      Height="200px"/>


        
        </MudListItem>


    }
    else
    {
        <MudListItem>
        
            <MudButtonGroup>
                <MudTextField
                    @bind-Value="UserGuess"
                    MaxLength="@Settings.WordLength"
                    HelperText="@($"Guess a {Settings.WordLength} letter word.")"
                    InputMode="InputMode.text"
                    InputType="InputType.Text"
                    Immediate="true"
                    Pattern="@Settings.Pattern"
                    Style="width:fit-content"/>
                <MudIconButton
                    Icon="@Icons.Filled.Add"
                    OnClick="AddGuess"
                    Disabled="!IsGoodGuess()"
                />
            </MudButtonGroup>

        
        </MudListItem>

        <MudListItem>
            <MudButton OnClick="Restart">Restart</MudButton>
        </MudListItem>
    }
    

</MudList>
<Blafettis @ref="Blafettis" duration="8000" elementCount="150" />

@code{


    public RunHistory History => _history;
    public GameState GameState => _gameState;

    private RunHistory _history = RunHistory.Empty;
    private GameState _gameState = GameState.Empty;
    private string _hiddenWord = "";

    private const string RunHistoryKey = "Nice5RunHistory";
    private const string GameStateKey = "Nice5GameState";

    private const string HiddenWordKey = "Nice5HiddenWord";

    private async Task SetHistory(RunHistory runHistory)
    {
        await _localStorage.SetItemAsync(RunHistoryKey, runHistory);
        _history = runHistory;
    }
    
    private async Task SetGameState(GameState gameState, string hw)
    {
        await _localStorage.SetItemAsStringAsync(GameStateKey, gameState.Serialize());
        _gameState = gameState;

        await _localStorage.SetItemAsStringAsync(HiddenWordKey, hw);
        _hiddenWord = hw;

    }

    private async Task GetGameStateFromLocalStorage()
    {
        var serialized = await _localStorage.GetItemAsStringAsync(GameStateKey);

        if (serialized is not null)
        {
            _gameState = GameStateSerialization.Deserialize(serialized);
            var hw = await _localStorage.GetItemAsStringAsync(HiddenWordKey);
            _hiddenWord = hw;
        }
            
        else //Set initial game state
        {
            _gameState = GameState.Empty;
            _hiddenWord = Settings.GetRandomHiddenWord(_gameState.MakeGuessResultOptimizer(), Random, false);
            UserGuess= Settings.GetRandomHiddenWord(_gameState.MakeGuessResultOptimizer(), Random, false);
            await AddGuess();
        }
    }

    private async Task GetHistoryFromLocalStorage()
    {
        var stuff = await _localStorage.GetItemAsync<RunHistory>(RunHistoryKey);

        if (stuff is not null)
            _history = stuff;
        else
        {
            _history = new RunHistory(ArraySegment<GameResult>.Empty);
        }
    }

    public GameSettings Settings { get; } = GameSettings.FiveLetter;

    public bool IsGameOver => GameState.IsWin || GameState.PreviousGuesses.Count >= Settings.MaxRounds;

    private string _userGuess = "";

    public string UserGuess
    {
        get => _userGuess;
        set => _userGuess = value.ToUpperInvariant();
    }
    
    
    public Random Random = new();
#pragma warning disable CS8618
    protected Blafettis Blafettis;
#pragma warning restore CS8618


    /// <inheritdoc />
    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();

        await GetGameStateFromLocalStorage();
        await GetHistoryFromLocalStorage();
    }
    

    public async Task Restart()
    {
        if (!IsGameOver)
        {
            var guessCount = GameState.IsWin ? GameState.PreviousGuesses.Count : null as int?;
            var gameResult = new GameResult(guessCount, _hiddenWord);
            await SetHistory(History.Add(gameResult));
        }

        var newHiddenWord = Settings.GetRandomHiddenWord(null, Random, false);
        await SetGameState(GameState.Empty, newHiddenWord);
        UserGuess = Settings.GetRandomHiddenWord(null, Random, false);
        await AddGuess();
    }


    public string? GetRealGuess()
    {
        var guess = UserGuess;

        guess = new string(guess.Trim().ToUpperInvariant().Where(char.IsLetter).ToArray());

        if(guess.Length != Settings.WordLength || !Settings.PossibleGuesses.Contains(guess))
            return null;

        return guess;
    }

    public bool IsGoodGuess() => GetRealGuess() is not null;

    private async Task AddGuess()
    {
        var guess = GetRealGuess();
        if (guess is null) return;

        var newGuessResult = GuessResult.ScoreWord(_hiddenWord, guess);
        
        await SetGameState(GameState.Add(newGuessResult), _hiddenWord);
        UserGuess = "";

        if (GameState.IsWin)
        {
            var gameResult = new GameResult(GameState.PreviousGuesses.Count, guess);
            await SetHistory(History.Add(gameResult));
            Blafettis.RaiseConfetti();  // raise confetti via method
        }

        if (GameState.PreviousGuesses.Count >= Settings.MaxRounds)
        {
            var gro = GameState.MakeGuessResultOptimizer();
            var hiddenWord = Settings.GetRandomHiddenWord(gro, Random, true);
            var gameResult = new GameResult(null, hiddenWord);
            await SetHistory(History.Add(gameResult));
        }
         
        
    }
    

}